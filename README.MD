# üè• Medical Appointment Backend - Sistema de Agendamiento de Citas M√©dicas



## üìã Tabla de Contenidos

- [Descripci√≥n del Negocio](#descripci√≥n-del-negocio)
- [Arquitectura](#arquitectura)
- [Tecnolog√≠as Utilizadas](#tecnolog√≠as-utilizadas)
- [Requisitos Previos](#requisitos-previos)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [Principios SOLID y Patrones](#principios-solid-y-patrones)
- [Variables de Entorno](#variables-de-entorno)

##  Descripci√≥n del Negocio

Un asegurado desea agendar una cita m√©dica ingresando a la aplicaci√≥n web donde escoge:
- Centro m√©dico
- Especialidad
- M√©dico
- Fecha y hora

Al presionar "Agendar", los datos se env√≠an al backend que responde indicando que el agendamiento est√° en proceso. El sistema procesa la solicitud de forma as√≠ncrona y notifica al usuario cuando la cita ha sido confirmada.

**Sistema multi-pa√≠s:** Funciona tanto para Per√∫ (PE) como Chile (CL), con procesamiento espec√≠fico por pa√≠s.

##  Arquitectura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cliente Web ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1. POST /appointments
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  API Gateway   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ 2. Invoke
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Lambda: Appointment‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ DynamoDB (status: pending)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ 3. Publish
           ‚ñº
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ                ‚îÇ
   ‚ñº                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇSNS PE‚îÇ        ‚îÇSNS CL‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò
    ‚îÇ               ‚îÇ
    ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇSQS PE‚îÇ        ‚îÇSQS CL‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò
    ‚îÇ               ‚îÇ 4. Process
    ‚ñº               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇLambda PE ‚îÇ   ‚îÇLambda CL ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ              ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ 5. Save to RDS
            ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  RDS MySQL ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ 6. Publish Event
            ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ EventBridge ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ    SQS     ‚îÇ
     ‚îÇConfirmation‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ 7. Update Status
            ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇLambda: Confirmation ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ DynamoDB (status: completed)
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

##  Tecnolog√≠as Utilizadas

- **Framework:** Serverless Framework v4
- **Runtime:** Node.js 20.x
- **Lenguaje:** TypeScript
- **Servicios AWS:**
  - API Gateway (REST API)
  - Lambda Functions
  - DynamoDB (Estado de citas)
  - RDS MySQL (Datos de citas por pa√≠s)
  - SNS (Notificaciones por pa√≠s)
  - SQS (Colas de mensajes)
  - EventBridge (Eventos del sistema)
  - CloudWatch (Logs)

##  Requisitos Previos

- Node.js >= 18.x
- npm >= 9.x
- AWS CLI configurado
- Cuenta de AWS con permisos administrativos
- Serverless Framework v4 instalado globalmente

```bash
npm install -g serverless
```


### Variables de Entorno

Crea un archivo `.env` en la ra√≠z del proyecto (no se incluye en el repositorio):

```env
# RDS Peru
RDS_PE_HOST=your-rds-pe-endpoint.rds.amazonaws.com
RDS_PE_PORT=3306
RDS_PE_DATABASE=appointmentspe
RDS_PE_USER=admin
RDS_PE_PASSWORD=your-secure-password

# RDS Chile
RDS_CL_HOST=your-rds-cl-endpoint.rds.amazonaws.com
RDS_CL_PORT=3306
RDS_CL_DATABASE=appointmentscl
RDS_CL_USER=admin
RDS_CL_PASSWORD=your-secure-password
```

### Base de Datos RDS

Ejecuta el script SQL en tus instancias RDS:

```bash
mysql -h your-rds-endpoint -u admin -p < database-schema.sql
```


### Base URL


```
https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev
```

### Endpoints

#### 1. Crear Cita (POST /appointments)

**Request:**

```bash
curl -X POST https://your-api-url/dev/appointments \
  -H "Content-Type: application/json" \
  -d '{
    "insuredId": "00123",
    "scheduleId": 100,
    "countryISO": "PE"
  }'
```

**Response (201 Created):**

```json
{
  "success": true,
  "message": "Appointment created successfully",
  "data": {
    "appointmentId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "pending",
    "message": "Appointment request is being processed"
  }
}
```

#### 2. Consultar Citas (GET /appointments/{insuredId})

**Request:**

```bash
curl https://your-api-url/dev/appointments/00123
```

**Response (200 OK):**

```json
{
  "success": true,
  "message": "Appointments retrieved successfully",
  "data": {
    "insuredId": "00123",
    "count": 2,
    "appointments": [
      {
        "appointmentId": "550e8400-e29b-41d4-a716-446655440000",
        "scheduleId": 100,
        "countryISO": "PE",
        "status": "completed",
        "createdAt": "2024-12-01T10:00:00Z",
        "updatedAt": "2024-12-01T10:05:00Z"
      },
      {
        "appointmentId": "660e8400-e29b-41d4-a716-446655440001",
        "scheduleId": 101,
        "countryISO": "PE",
        "status": "pending",
        "createdAt": "2024-12-02T14:30:00Z",
        "updatedAt": "2024-12-02T14:30:00Z"
      }
    ]
  }
}
```

### Validaciones

- `insuredId`: Debe ser un string de 5 d√≠gitos (ej: "00123")
- `scheduleId`: Debe ser un n√∫mero entero positivo
- `countryISO`: Debe ser "PE" o "CL"




## üìÅ Estructura del Proyecto

```
medical-appointment-backend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appointment/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handler.ts          # API Gateway handler
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ confirmation.ts     # Confirmation handler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appointment-pe/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handler.ts          # PE processor
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ appointment-cl/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ handler.ts          # CL processor
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ interfaces/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ appointment.interface.ts
‚îÇ       ‚îú‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dynamodb.repository.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ rds.repository.ts
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ appointment.service.ts
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sns.service.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ eventbridge.service.ts
‚îÇ       ‚îî‚îÄ‚îÄ utils/
‚îÇ           ‚îú‚îÄ‚îÄ response.util.ts
‚îÇ           ‚îî‚îÄ‚îÄ validator.util.ts
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ setup.ts
‚îÇ   ‚îú‚îÄ‚îÄ validator.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ appointment.service.test.ts
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ openapi.yaml              # Documentaci√≥n OpenAPI/Swagger
‚îú‚îÄ‚îÄ serverless.yml                # Configuraci√≥n de infraestructura
‚îú‚îÄ‚îÄ database-schema.sql           # Schema de base de datos
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ jest.config.js
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üé® Principios SOLID y Patrones

### SOLID Principles

1. **Single Responsibility (S):** Cada clase tiene una √∫nica responsabilidad
   - `AppointmentService`: Solo maneja l√≥gica de negocio de citas
   - `DynamoDBRepository`: Solo acceso a DynamoDB
   - `ValidatorUtil`: Solo validaciones

2. **Open/Closed (O):** Abierto para extensi√≥n, cerrado para modificaci√≥n
   - F√°cil agregar nuevos pa√≠ses sin modificar c√≥digo existente

3. **Liskov Substitution (L):** Las interfaces permiten sustituir implementaciones

4. **Interface Segregation (I):** Interfaces espec√≠ficas y peque√±as

5. **Dependency Inversion (D):** Dependencia de abstracciones, no implementaciones concretas
   - Inyecci√≥n de dependencias en `AppointmentService`

### Patrones de Dise√±o

1. **Repository Pattern:** `DynamoDBRepository`, `RDSRepository`
   - Abstrae el acceso a datos

2. **Facade Pattern:** `AppointmentService`
   - Simplifica operaciones complejas

3. **Strategy Pattern:** `SNSService`
   - Selecci√≥n de topic seg√∫n pa√≠s

4. **Observer Pattern:** EventBridge
   - Notificaciones de eventos del sistema

5. **Dependency Injection:** Constructores de servicios
   - Facilita testing y mantenibilidad

## üîê Variables de Entorno

| Variable | Descripci√≥n | Ejemplo |
|----------|-------------|---------|
| `DYNAMODB_TABLE` | Nombre de la tabla DynamoDB | `appointments-dev` |
| `SNS_TOPIC_PE_ARN` | ARN del topic SNS para Per√∫ | `arn:aws:sns:...` |
| `SNS_TOPIC_CL_ARN` | ARN del topic SNS para Chile | `arn:aws:sns:...` |
| `RDS_PE_HOST` | Host de RDS Per√∫ | `xxx.rds.amazonaws.com` |
| `RDS_CL_HOST` | Host de RDS Chile | `yyy.rds.amazonaws.com` |

##  Monitoreo

- **CloudWatch Logs:** Ver logs de todas las lambdas
- **CloudWatch Metrics:** M√©tricas de invocaciones, errores, duraci√≥n
- **X-Ray:** Trazabilidad de requests (opcional)




## üë®‚Äçüíª Autor

Backend Team 

